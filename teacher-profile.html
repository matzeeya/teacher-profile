<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../jwt-decode/jwt-decode.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="t-profile.html">
<link rel="import" href="teacher-list-education.html">
<link rel="import" href="teacher-list-work.html">
<link rel="import" href="teacher-list-operating.html">

<link href="https://fonts.googleapis.com/css?family=Kanit" rel="stylesheet">

<dom-module id="teacher-profile">
  <template>
    <style is="customer-style" include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      .font-face-big-bold {
        font-family: 'Kanit', sans-serif;
        font-size: 120%;
        font-weight: bold;
      }

      paper-tabs {
        --paper-tabs-selection-bar-color: #F44336;
        background-color: var(--paper-grey-50);
        height: 40px;
      }

      paper-button{
        font-family: 'Kanit', sans-serif;
        font-size: 100%;
        color:#000;
      }
    </style>

        <paper-tabs selected="{{page}}" noink scrollable fit-container>
          <paper-tab>
            <div class="font-face-big-bold">ข้อมูลทั่วไป</div>
          </paper-tab>
          <paper-tab>
            <div class="font-face-big-bold">คุณวุฒิและความชำนาญ</div>
          </paper-tab>
          <paper-tab>
            <div class="font-face-big-bold">ประวัติการทำงาน</div>
          </paper-tab>
          <paper-tab>
            <div class="font-face-big-bold">ประวัติการปฏิบัติงาน</div>
          </paper-tab>
          <paper-tab>
            <div class="font-face-big-bold">ประวัติการพัฒนา</div>
          </paper-tab>
        </paper-tabs>

        <iron-pages selected="{{page}}"> 
          <div>
            <t-profile value="{{document.value}}"></t-profile>
          </div>
          <div>
            <teacher-list-education value="{{document.value.education_list}}"></teacher-list-education>
          </div>
          <div>
            <teacher-list-work value="{{document.value}}"></teacher-list-work>
          </div>
          <div>
            <teacher-list-operating value="{{document.value}}"></teacher-list-operating>
          </div>
          <div>
            กำลังดำเนินการ
          </div>
        </iron-pages>

         <div class="buttons">
          <paper-button dialog-dismiss raised>ยกเลิก</paper-button>
          <paper-button raised on-click="update">บันทึก</paper-button>
          <paper-button dialog-confirm raised>ปิด</paper-button>
        </div>
    
  </template>

  <script>
    class TeacherProfile extends Polymer.Element {
      static get is() { return 'teacher-profile'; }
      static get properties() {
        return {
          token: {
            type: String,
            notify:true
          },
          app: {
            type: String,
            notify:true
          },
          active:{
            type: Boolean,
            reflectToAttribute:true,
            notify:true,
            observer:'_isActive'
          },
          page:{
            type:Number,
            value:0
          }
        };
      }

      static get observers() {
        return [
          '__decodeJwt(token,app)',
        ];
      }

      onStatusChanged(event) {
        this.set('active',event.detail.value);
      }

      _isActive(active) {
        if(active) {
          this.$.dialog.open();
        } else {
          this.$.dialog.close();
        }
      }

      __decodeJwt(token,app) {
        if(!token || !app) return;
        var self = this;
        try {
          var profile = jwt_decode(token,{'header':false});
          var ele = document.createElement('iron-request');
          ele.send({
            url:'https://maas.nuqlis.com:9000/apis/query/role_db/app_user',
            method:'POST',
            headers:{
              'Authorization':'JWT '+token,
              'Content-Type':'application/json'
            },
            handleAs:'json',
            body:{'match':[app,profile.UserID],'limit':1,'include_doc':true}
          }).then(function(res) {
            if(res.response.length == 1) {
              var doc = res.response[0].value.doc;
              if(doc.profile.teacher_id) {
                var tle = document.createElement('iron-request');
                tle.send({
                  url:'https://maas.nuqlis.com:9000/apis/dbs/teacher_db/'+doc.profile.teacher_id,
                  method:'GET',
                  handleAs:'json',
                  headers:{
                   'Authorization':'JWT '+token,
                  },
                }).then(function(res) {
                  var response = res.response;                  
                  if(!response.hasOwnProperty("education_list")) {
                    response["education_list"] = [];
                  }
                  self.set('document',{
                    'key':doc.profile.teacher_id,
                    'value':response
                  });
                });
              }
            }
          });
        } catch(e) {
        }
      }
      
      update(event) {
        if(!this.document.key) return;
        var self = this;
        var ele = document.createElement('iron-request');
        var key = this.document.key;
        var value = this.document.value;
        ele.send({
          url:'https://maas.nuqlis.com:9000/apis/dbs/teacher_db/'+key,
          method:'POST',
          headers:{
              'Authorization':'JWT '+this.token,
              'Content-Type':'application/json'
            },
            handleAs:'json',
            body:value
          }).then(function(res) {
            if(res.response.ok) {
              self.set('active',false);
            }
          });
 
      }
    }

    window.customElements.define(TeacherProfile.is, TeacherProfile);
  </script>
</dom-module>
