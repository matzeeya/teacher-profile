<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="../jwt-decode/jwt-decode.html">

<dom-module id="teacher-profile">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <paper-input label="Token" value="{{token}}">
    </paper-input>
    <paper-input label="Application" value="{{app}}">
    </paper-input>
    <paper-checkbox checked="{{active}}">Active</paper-checkbox>

    <paper-dialog id="dialog">
     <h2>Header</h2>
     <p>
       <paper-input value="{{document.value.firstname}}" label="ชื่อ">
       </paper-input>
       <paper-input value="{{document.value.lastname}}" label="นามสกุล">
       </paper-input>
     </p>
     <div class="buttons">
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button dialog-confirm autofocus on-click="update">Save</paper-button>
     </div>
    </paper-dialog>
    
  </template>

  <script>
    class TeacherProfile extends Polymer.Element {
      static get is() { return 'teacher-profile'; }
      static get properties() {
        return {
          token: {
            type: String,
            notify:true
          },
          app: {
            type: String,
            notify:true
          },
          active:{
            type: Boolean,
            reflectToAttribute:true,
            notify:true,
            observer:'_isActive'
          }
        };
      }

      static get observers() {
        return [
          '__decodeJwt(token,app)',
        ];
      }

      _isActive(active) {
        if(active) {
          this.$.dialog.open();
        } else {
          this.$.dialog.close();
        }
      }

      __decodeJwt(token,app) {
        if(!token || !app) return;
        var self = this;
        try {
          var profile = jwt_decode(token,{'header':false});
          var ele = document.createElement('iron-request');
          ele.send({
            url:'https://maas.nuqlis.com:9000/apis/query/role_db/app_user',
            method:'POST',
            headers:{
              'Authorization':'JWT '+token,
              'Content-Type':'application/json'
            },
            handleAs:'json',
            body:{'match':[app,profile.UserID],'limit':1,'include_doc':true}
          }).then(function(res) {
            if(res.response.length == 1) {
              var doc = res.response[0].value.doc;
              if(doc.profile.teacher_id) {
                var tle = document.createElement('iron-request');
                tle.send({
                  url:'https://maas.nuqlis.com:9000/apis/dbs/teacher_db/'+doc.profile.teacher_id,
                  method:'GET',
                  handleAs:'json',
                  headers:{
                   'Authorization':'JWT '+token,
                  },
                }).then(function(res) {
                  self.set('document',{
                    'key':doc.profile.teacher_id,
                    'value':res.response
                  });
                });
              }
            }
          });
        } catch(e) {
        }
      }
      
      update(event) {
        if(!this.document.key) return;
        var ele = document.createElement('iron-request');
        var key = this.document.key;
        var value = this.document.value;
        ele.send({
          url:'https://maas.nuqlis.com:9000/apis/dbs/teacher_db/'+key,
          method:'POST',
          headers:{
              'Authorization':'JWT '+this.token,
              'Content-Type':'application/json'
            },
            handleAs:'json',
            body:value
          }).then(function(res) {
            console.log(res.response);
          });
 
      }
    }

    window.customElements.define(TeacherProfile.is, TeacherProfile);
  </script>
</dom-module>
